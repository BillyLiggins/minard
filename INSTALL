set -e; sudo -v || exit

# apt-get install package dependencies
if [ -f /etc/debian_version]; then
   sudo apt-get install git dpkg-dev make g++ gcc binutils libx11-dev libxpm-dev \
       libxft-dev libxext-dev \
       gfortran libssl-dev libpcre3-dev \
       xlibmesa-glu-dev libglew1.5-dev libftgl-dev \
       libmysqlclient-dev libfftw3-dev cfitsio-dev \
       graphviz-dev libavahi-compat-libdnssd-dev \
       libldap2-dev python-dev libxml2-dev libkrb5-dev \
       libgsl0-dev libqt4-dev \
       curl libcurl3 bzip2 libbz2-1.0 scons
elif [ -f /etc/redhat-release ]; then
   sudo yum install git make gcc-c++ gcc binutils \
       libX11-devel libXpm-devel libXft-devel libXext-devel \
       gcc-gfortran openssl-devel pcre-devel \
       mesa-libGL-devel glew-devel ftgl-devel mysql-devel \
       fftw-devel cfitsio-devel graphviz-devel \
       avahi-compat-libdns_sd-devel libldap-dev python-devel \
       libxml2-devel gsl-static \
       curl curl-devel bzip2 bzip2-devel scons
else
    echo "Error! Couldn't determine Linux distribution!"
    echo "no /etc/debian_version or /etc/redhat-release file"
    exit 1
fi

add_service () {
    if [ -f /etc/debian_version ]; then
        sudo update-rc.d $1 defaults
    elif [ -f /etc/redhat-release ]; then
        sudo chkconfig --add $1
        sudo chkconfig --level 2345 $1 on
    else
        echo "Error! Couldn't determine Linux distribution!"
        echo "no /etc/debian_version or /etc/redhat-release file"
        exit 1
    fi
}
    
if ! hash redis-server 2>/dev/null; then
    # install redis to /usr/local
    echo "Installing redis..."
    cd /usr/local
    sudo curl -O http://download.redis.io/redis-stable.tar.gz
    sudo tar -xzvf redis-stable.tar.gz
    cd redis-stable
    sudo make
    sudo make install
fi

# make directories for redis
# see "Installing Redis more properly" at http://redis.io/topics/quickstart
sudo mkdir -p /etc/redis /var/redis /opt/redis

# install redis init script
sudo curl -o /etc/init.d/redis_6379 \
https://raw.githubusercontent.com/tlatorre-uchicago/minard/master/utils/redis_6379

sudo chmod +x /etc/init.d/redis_6379

sudo curl -o /etc/redis/6379.conf \
https://raw.githubusercontent.com/tlatorre-uchicago/minard/master/utils/redis.conf

add_service redis_6379

if [ ! -d /opt/minard ]; then
    sudo mkdir /opt/minard
    sudo chown $USER /opt/minard
fi

if [ ! -f /opt/minard/bin/activate ]; then
    # create virtual environment
    virtualenv /opt/minard
fi

cd /opt/minard
source bin/activate

if [ ! -d /opt/minard/src ]; then
    mkdir src
fi

if [ ! -d /opt/minard/src/minard ]; then
    cd $VIRTUAL_ENV/src
    git clone git@github.com:tlatorre-uchicago/minard.git
    pip install ./minard
    cd minard/doc
    make html
    cp -r _build/html /opt/minard/www/static/doc
    fi

# make sure www-data user exists
if ! id -u www-data 2>/dev/null; then
    echo "Adding www-data user..."
    sudo useradd -r www-data
fi

# make sure snoplusmon user exists
if ! id -u snoplusmon 2>/dev/null; then
    echo "Adding snoplusmon user..."
    sudo useradd -r snoplusmon
fi

sudo curl -o /etc/init.d/gunicorn \
https://raw.githubusercontent.com/tlatorre-uchicago/minard/master/utils/gunicorn

sudo chmod +x /etc/init.d/gunicorn

add_service gunicorn

sudo mkdir -p /etc/minard
sudo mkdir -p /var/run/minard
sudo chown snoplusmon:snoplusmon /var/run/minard

# add monitoring init scripts
for name in minard_dispatch minard_builder orca_producer orca_consumer; do
    sudo cp $VIRTUAL_ENV/src/minard/utils/$name /etc/init.d/
    add_service $name
done

if [ ! -d /opt/minard/src/root ]; then
    # install Root
    cd $VIRTUAL_ENV/src
    curl -O ftp://root.cern.ch/root/root_v5.34.18.source.tar.gz
    tar -xzvf root_v5.34.01.source.tar.gz
    cd root
    ./configure --enable-minuit2 --enable-python
    make -j4
    source bin/thisroot.sh
    cd ..
    echo "source $VIRTUAL_ENV/src/root/bin/thisroot.sh" >> $VIRTUAL_ENV/bin/activate
fi

if [ ! -d /opt/minard/src/geant4.9.5.p01 ]; then
    # install Geant4
    cd $VIRTUAL_ENV/src
    curl -O http://geant4.cern.ch/support/source/geant4.9.5.p01.tar.gz
    tar -xzvf geant4.9.5.p01.tar.gz
    mkdir geant4.9.5.p01-build
    cd geant4.9.5.p01-build
    cmake -DCMAKE_INSTALL_PREFIX=$VIRTUAL_ENV/src/geant4.9.5.p01 $VIRTUAL_ENV/src/geant4.9.5.p01 
    make -j8
    make install
    cd ..
    source geant4.9.5.p01/bin/geant4.sh
    echo "source $VIRTUAL_ENV/src/geant4.9.5.p01/bin/geant4.sh" >> $VIRTUAL_ENV/bin/activate
fi

if [ ! -d /opt/minard/src/rat ]; then
    # RAT
    cd $VIRTUAL_ENV/src
    git clone git@github.com:snoplus/rat
    cd rat
    # need to go back to release 4.5.0
    git checkout 12c07de85f0f24b824ce2ff5c3ac4b193bea680d
    ./configure
    source env.sh
    scons -j4
    cd ..
    echo "source $VIRTUAL_ENV/src/rat/env.sh" >> $VIRTUAL_ENV/bin/activate
fi

if [ ! -d /opt/minard/src/rat-tools ]; then
    # rat-tools
    cd $VIRTUAL_ENV/src
    git clone git@github.com:snoplus/rat-tools.git
    cd rat-tools
    git checkout 27af7f240965c823816ed9bfb7fecdccb040a9ca
    cd ratzdab
    make
    source env.sh
    echo "source $VIRTUAL_ENV/src/rat-tools/ratzdab/env.sh" >> $VIRTUAL_ENV/bin/activate
fi

echo "done! Make sure to install the builder key at /etc/minard/id_rsa_builder "
echo "and the flask settings file at /etc/minard/settings.cfg"
