{% extends "layout.html" %}
{% block title %}Channel Status{% endblock %}
{% block head %}
    {{ super() }}
{% endblock %}
{% block body %}
    {{ super() }}
    <div class="container">
	{% if error %}
	<div class="alert alert-danger" role="alert">
	    <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
	    {{ error }}
	</div>
	{% endif %}
	<div class="row">
	    <div class="col-md-2">
                <form>
                    <div class="form-group">
                        <label for="Crate">Crate</label>
                        <select class="form-control" id="crate">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                            <option value="19">19</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Slot</label>
                        <select class="form-control" id="slot">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Channel</label>
                        <select class="form-control" id="channel">
                            <option value="0">0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                            <option value="19">19</option>
                            <option value="20">20</option>
                            <option value="21">21</option>
                            <option value="22">22</option>
                            <option value="23">23</option>
                            <option value="24">24</option>
                            <option value="25">25</option>
                            <option value="26">26</option>
                            <option value="27">27</option>
                            <option value="28">28</option>
                            <option value="29">29</option>
                            <option value="30">30</option>
                            <option value="31">31</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary" id="update">Update</button>
                </form>
            </div>
        </div>
        <div class="row">
        {% macro status(data) %}
            <td>
            {% if data %}
                <span class="glyphicon glyphicon-ok"></span>
            {% endif %}
            </td>
        {% endmacro %}
	    <div class="col-md-12">
                <h2>Channel History</h2>
		<table class="table table-condensed text-center">
		    <thead>
			<tr>
			    <th>Date</th>
			    <th>PMT Removed</th>
			    <th>PMT Reinstalled</th>
			    <th>Low Occ.</th>
			    <th>Zero Occ.</th>
			    <th>Screamer</th>
			    <th>Bad Disc.</th>
			    <th>No N100</th>
			    <th>No N20</th>
			    <th>No ESUM</th>
			    <th>Cable pulled</th>
			    <th>Bad Cable</th>
			    <th>Resistor pulled</th>
			    <th>Disable N100</th>
			    <th>Disable N20</th>
			    <th>Bad Base Current</th>
			    <th>Name</th>
			    <th>Info</th>
			</tr>
		    </thead>
		    {% for row in results %}
		    <tr>
			<td>{{ row['timestamp'].strftime("%Y-%m-%d") }}</td>
			{{ status(row['pmt_removed']) }}
			{{ status(row['pmt_reinstalled']) }}
			{{ status(row['low_occupancy']) }}
			{{ status(row['zero_occupancy']) }}
			{{ status(row['screamer']) }}
			{{ status(row['bad_discriminator']) }}
			{{ status(row['no_n100']) }}
			{{ status(row['no_n20']) }}
			{{ status(row['no_esum']) }}
			{{ status(row['cable_pulled']) }}
			{{ status(row['bad_cable']) }}
			{{ status(row['resistor_pulled']) }}
			{{ status(row['disable_n100']) }}
			{{ status(row['disable_n20']) }}
			{{ status(row['bad_base_current']) }}
                        <td>{{ row['name'] }}</td>
                        <td>{{ row['info'] }}</td>
		    </tr>
		    {% endfor %}
		</table>
	    </div>
	</div>
	<div class="row">
	    <div class="col-md-12">
                <h2>PMT Info</h2>
		<table class="table">
		    <thead>
			<tr>
			    <th>Cable</th>
			    <th>PMT</th>
			    <th>PC</th>
			    <th>QCCC</th>
			    <th>Bundle</th>
			    <th>HV</th>
			    <th>Type</th>
			    <th>x</th>
			    <th>y</th>
			    <th>z</th>
			    <th>Panel</th>
			</tr>
		    </thead>
		    <tr>
                        {% macro pmt_type_hex_to_description(type) %}
                            {% if type == '0x03'|int(base=16) %}
                                Normal
                            {% elif type == '0x21'|int(base=16) %}
                                Low Gain
                            {% elif type == '0x41'|int(base=16) %}
                                OWL
                            {% elif type == '0x10'|int(base=16) %}
                                FECD
                            {% elif type == '0x09'|int(base=16) %}
                                Neck
                            {% elif type == '0x81'|int(base=16) %}
                                Butt
                            {% elif type == '0x00'|int(base=16) %}
                                No PMT
                            {% elif type == '0x100'|int(base=16) %}
                                HQE PMT
                            {% else %}
                                Unknown ({{ type }})
                            {% endif %}
                        {% endmacro %}
                        {% if pmt_info %}
			<td>{{ pmt_info['cable'] }}</td>
			<td>{{ pmt_info['pmt'] }}</td>
			<td>{{ pmt_info['pc'] }}</td>
			<td>{{ pmt_info['qccc'] }}</td>
			<td>{{ pmt_info['bundle'] }}</td>
			<td>{{ pmt_info['hv'] }}</td>
			<td>{{ pmt_type_hex_to_description(pmt_info['type']) }}</td>
			<td>{{ pmt_info['x'] }}</td>
			<td>{{ pmt_info['y'] }}</td>
			<td>{{ pmt_info['z'] }}</td>
			<td>{{ pmt_info['panel'] }}</td>
                        {% endif %}
		    </tr>
		</table>
	    </div>
	</div>
    </div>
{% endblock %}
{% block script %}
    <script>
        if (url_params.crate) {
            document.getElementById("crate").value = url_params.crate;
        }
        if (url_params.slot) {
            document.getElementById("slot").value = url_params.slot;
        }
        if (url_params.channel) {
            document.getElementById("channel").value = url_params.channel;
        }
        $("#crate, #slot, #channel").on("change", function() {
            var params = {};
            if (document.getElementById("crate").value != -1) {
                params['crate'] = document.getElementById("crate").value;
            }
            if (document.getElementById("slot").value != -1) {
                params['slot'] = document.getElementById("slot").value;
            }
            if (document.getElementById("channel").value != -1) {
                params['channel'] = document.getElementById("channel").value;
            }
            window.location.replace($SCRIPT_ROOT + "/channel-status?" + $.param(params));
        });
        $("#update").click(function () {
            var params = {'crate': $("#crate").val(), 'slot': $('#slot').val(), 'channel': $("#channel").val()};
            window.location.href = $SCRIPT_ROOT + "/update-channel-status?" + $.param(params);
        });
    </script>
{% endblock %}
