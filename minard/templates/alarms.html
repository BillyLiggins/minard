{% extends "layout.html" %}
{% block title %}Alarms{% endblock %}
{% block head %}
{{ super() }}
<style>
    .word-wrap {
        word-wrap: break-word;
    }

    .monospace {
        font-family:monospace;
    }

    .label-block {
        display: inline-block;
        min-width: 60px;
    }

    .line {
        border-bottom: 1px solid black;
        margin-bottom: 10px;
    }
</style>
  <script src="{{ url_for('static', filename='js/moment.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/moment-timezone-with-data.min.js') }}"></script>
{% endblock %}
{% block body %}
{{ super() }}
<div class="container">
    <div class="page-header">
        <h1>Alarms <small><span id="time"></span></small></h1>
    </div>

    <div class="row">
        <div class="col-md-1 col-md-push-11 text-center">
            <h4>View</h4>
            <form>
                <div class="checkbox">
                    <input type="checkbox" name="view" value="debug">
                    <span class="label label-default label-block">Debug</span>
                    <br>
                    <input type="checkbox" name="view" value="info">
                    <span class="label label-info label-block">Info</span>
                    <br>
                    <input type="checkbox" name="view" value="success">
                    <span class="label label-success label-block">Success</span>
                    <br>
                    <input type="checkbox" name="view" value="warning">
                    <span class="label label-warning label-block">Warning</span>
                    <br>
                    <input type="checkbox" name="view" value="danger">
                    <span class="label label-danger label-block">Error</span>
                    <br>
                    <input type="checkbox" name="view" value="unknown">
                    <span class="label label-default label-block">???</span>
                    <br>
                </div>
            </form>
        </div>
        <div class="col-md-11 col-md-pull-1 word-wrap monospace" id="log"></div>
    </div>
</div>

<script>

setInterval(function() { $('#time').text(moment().tz('America/Toronto').format('HH:mm:ss')); }, 1000);

// checkboxes are checked by default
$('input[name="view"]').prop('checked',true);
// show/hide labels when checked/unchecked
$('input[name="view"]').click(function() {
    if ($(this).is(':checked')) {
        $('p span.label-' + $(this).val()).parent().show();
    } else {
        $('p span.label-' + $(this).val()).parent().hide();
    }
});

var level_labels = {
    'SUCCESS' : '<span class="label label-success label-block">Success</span>',
    'INFO'    : '<span class="label label-info label-block">Info</span>',
    'WARNING' : '<span class="label label-warning label-block">Warning</span>',
    'ERROR'   : '<span class="label label-danger label-block">Error</span>',
    'DEBUG'   : '<span class="label label-default label-debug label-block">Debug</span>',
    'UNKNOWN' : '<span class="label label-default label-unknown label-block">???</span>',
    21        : '<span class="label label-success label-block">Success</span>',
    20        : '<span class="label label-info label-block">Info</span>',
    30        : '<span class="label label-warning label-block">Warning</span>',
    40        : '<span class="label label-danger label-block">Error</span>',
    10        : '<span class="label label-default label-debug label-block">Debug</span>',
}

function same_day(a, b)
{
    return (a.date() == b.date()) && (a.month() == b.month()) && (a.year() == b.year());
}

var _last_date = null;

function update_alarms(start)
{
    if (typeof(start) === 'undefined') start = -100;

    $.getJSON($SCRIPT_ROOT + '/get_alarm?start=' + start).done(function(obj) {
        var now = moment().tz('America/Toronto');

        for (var i=0; i < obj.alarms.length; i++)
        {
            var alarm = obj.alarms[i];

            var mom = moment(alarm.time);

            if (mom.isValid())
            {
                if (_last_date == null)
                {
                    _last_date = mom;
                } else
                {
                    if (!same_day(_last_date, mom))
                    {
                        $('#log').prepend('<div class="line text-center">' + _last_date.format('MM/DD/YYYY') + '</div>');
                        _last_date = mom;
                    }
                }

                var label;
                var level = alarm.level;
                if (level in level_labels)
                {
                    label = level_labels[level];
                } else {
                    label = level_labels['UNKNOWN'];
                }

                var p = $('<p>')
                    .append(label)
                    .append(' ')
                    .append(mom.format('HH:mm:ss'))
                    .append(' ')
                    .append(alarm.message);

                $('#log').prepend(p);

                if ((i == obj.alarms.length-1) && !same_day(now,mom))
                {
                    $('#log').prepend('<div class="line text-center">' + mom.format('MM/DD/YYYY') + '</div>');
                    _last_date = now;
                }
            } else {
                // print whole message
                $('#log').prepend('<p>' + level_labels['UNKNOWN'] + ' ' + alarm.message);
            }
        }
        $("#log p").slice(1000).remove();
        setTimeout(function() { update_alarms(obj.latest+1) },1000); // 1 second
    });
};

update_alarms();
</script>

{% endblock %}
