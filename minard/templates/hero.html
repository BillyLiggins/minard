{% extends "layout.html" %}

{% block title %}Detector{% endblock %}
{% block head %}
    {{ super() }}

    <style>
        .graticule {
            fill: none;
            stroke: #777;
            stroke-opacity: .5;
            stroke-width: .5px;
        }

        .land {
            fill: #222;
        }

        .boundary {
            fill: none;
            stroke: #fff;
            stroke-width: .5px;
        }
    </style>
{% endblock %}

{% block body %}
    {{ super() }}
    <div class="container" id="hero"></div>
    <script src="{{ url_for('static', filename='js/d3.js') }}"></script>
    <script>
        $(function(){
        var element = $('#hero');
        var width   = element.width();
        var height  = width/2.0;

        var selection = d3.select(element.get());

        var pmtinfo = {% include 'airfill2.json' %};

        var coords = [];
        for (var i=0; i < pmtinfo['x'].length; i++){
            var x = pmtinfo['x'][i],
                y = pmtinfo['y'][i],
                z = pmtinfo['z'][i];

            var r = Math.sqrt(x*x + y*y + z*z);

            var theta = Math.acos(z/r)*180.0/Math.PI - 90.0;
            var phi   = Math.atan2(y,x)*180.0/Math.PI;

            coords[i] = [phi, theta];
        }

        var projection = d3.geo.mercator()
            .scale((width + 1) / 2 / Math.PI)
            .translate([width / 2, height / 2])
            .precision(.1);

        var path = d3.geo.path()
            .projection(projection);

        var graticule = d3.geo.graticule();

        var svg = d3.select(element[0]).append("svg")
            .attr("width", width)
            .attr("height", height);

        svg.append("path")
            .datum(graticule)
            .attr("class", "graticule")
            .attr("d", path);

        d3.select(self.frameElement).style("height", height + "px");

        $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

        function update() {
        return $.getJSON($SCRIPT_ROOT + '/get', { name: 'sphere' });
        }

        pos = []
        for (var i=0; i < coords.length; i++)
            pos[i] = projection(coords[i]);

        function on_done(result){
            id = result.id;
            values = result.values2;

            for (var i=0; i < id.length; i++) {
                if (typeof(pos[id[i]]) === 'undefined')
                        alert('undefined for i = ' + i + '!');
            }

            var circle = svg.selectAll('circle').data(id,String);

            circle.exit().remove();

            circle.enter().append('circle')
                .style('fill','steelblue')
                .attr('cx',function(d, i) { return pos[d][0]; })
                .attr('cy',function(d, i) { return pos[d][1]; })
                .attr('r', function(d, i) { return values[i]; });
        }

        update().done(on_done);

        setInterval(function() { update().done(on_done);},5000);
        }());
    </script>

    <script>$('#nav-detector').attr('class','active');</script>

{% endblock %}
