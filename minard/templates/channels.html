{% extends "layout.html" %}
{% block title %}Channels{% endblock %}
{% block head %}
{{ super() }}
<style>
    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

    .bar {
        fill: steelblue;
    }

    .x.axis path {
        display: none;
    }

    .x.label {
        font-size: 15px;
        font-weight: normal;
    }

    .tick text {
        font-size: 10px;
    }
</style>
<meta charset="UTF-8">
<script src="{{ url_for('static', filename='js/d3.js') }}"></script>
<script src="{{ url_for('static', filename='js/bar-chart.js') }}"></script>
<script src="{{ url_for('static', filename='js/crate.js') }}"></script>
{% endblock %}
{% block body %}
{{ super() }}
<div class="container">
    <div class="row">
        <div class="col-md-6">
            <h2>CMOS Rates</h2>
            <div class="row">
                <div class="col-md-6">
                    <h4>Options</h4>
                    <div class="form-group">
                    <div class='input-group input-group-sm'>
                        <span class='input-group-addon'>Threshold (kHz):</span>
                        <input type='text' class='form-control' id='cmos-threshold'>
                        <span class='input-group-btn'>
                        <button class='btn btn-default' type='button' id='cmos-threshold-btn'>Set</button>
                        </span>
                        <script>
                            // Set threshold when <Enter> key is pressed
                            $('#cmos-threshold').keyup(function(event) {
                                if (event.keyCode == 13)
                                    $('#cmos-threshold-btn').click();
                            });
                        </script>
                    </div></div>
                    <div class="form-group">
                    <div class='input-group input-group-sm'>
                        <span class='input-group-addon'>Stats:</span>
                        <select class='form-control' id='cmos-stats'>
                            <option>now</option>
                            <option>avg</option>
                            <option>max</option>
                        </select>
                    </div></div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12" id="cmos-hero" style="position:relative">
                    <h4>Chart View</h4>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12" id="cmos-crate">
                    <h4>Crate View</h4>
                </div>
            </div>
        </div>

        <!-- Base Currents -->
        <div class="col-md-6">
            <h2>Base Currents</h2>
            <div class="row">
                <div class="col-md-6">
                    <h4>Options</h4>
                    <div class="form-group">
                    <div class='input-group input-group-sm'>
                        <span class='input-group-addon'>Threshold (ADC):</span>
                        <input type='text' class='form-control' id='base-threshold'>
                        <span class='input-group-btn'>
                        <button class='btn btn-default' type='button' id='base-threshold-btn'>Set</button>
                        </span>
                        <script>
                            // Set threshold when <Enter> key is pressed
                            $('#base-threshold').keyup(function(event) {
                                if (event.keyCode == 13)
                                    $('#base-threshold-btn').click();
                            });
                        </script>
                    </div></div>
                    <div class="form-group">
                    <div class='input-group input-group-sm'>
                        <span class='input-group-addon'>Stats:</span>
                        <select class='form-control' id='base-stats'>
                            <option>now</option>
                            <option>avg</option>
                            <option>max</option>
                        </select>
                    </div></div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12" id="base-hero" style="position:relative">
                    <h4>Chart View</h4>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12" id="base-crate">
                    <h4>Crate View</h4>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

    var cmos_crate = crate_view().threshold(10e3);
    var base_crate = crate_view().threshold(50);

    $('#cmos-threshold').val(cmos_crate.threshold()/1e3);

    $('#cmos-threshold-btn').click(function() {
        cmos_crate.threshold($('#cmos-threshold').val()*1e3);
    });

    $('#base-threshold').val(base_crate.threshold());

    $('#base-threshold-btn').click(function() {
        base_crate.threshold($('#base-threshold').val());
    });

    var interval = 2000;

    setInterval(function() {
        $.getJSON($SCRIPT_ROOT + '/query', {name: 'cmos', stats: $('#cmos-stats').val()}).done(function(result) {
            d3.selectAll('#cmos-crate').data([result.value]).call(cmos_crate);
        });
    }, interval);

    setInterval(function() {
        $.getJSON($SCRIPT_ROOT + '/query', {name: 'cmos', format: 'nested', stats: $('#cmos-stats').val()}).done(function(result) {
            update('#cmos-hero',result.value);
        });
    }, interval);

    setInterval(function() {
        $.getJSON($SCRIPT_ROOT + '/query', {name: 'base', stats: $('#base-stats').val()}).done(function(result) {
            d3.selectAll('#base-crate').data([result.value]).call(base_crate);
        });
    }, interval);

    setInterval(function() {
        $.getJSON($SCRIPT_ROOT + '/query', {name: 'base', format: 'nested', stats: $('#base-stats').val()}).done(function(result) {
            update('#base-hero',result.value);
        });
    }, interval);

    function update(node, data) {
        if (data === 'undefined') {
            d3.select(node).datum(d3.select(node).datum()).call(chart);
        } else {
            d3.select(node).datum(data).call(chart);
        }
    }

    d3.select('#cmos-hero').node().level = [[]];
    d3.select('#base-hero').node().level = [[]];
    function nav(root, level) {
        for (var i=0; i < level.length; i++)
            root = root[level[i]];
        return root;
    }

    var chart = bar_chart().xlabel('Crate').margin({left:35});

    chart.click(function(d, i) {
        var node = this.parentNode.parentNode.parentNode;
        var level = node.level;
        if (level.length < 3) {
            level.unshift(level[0].concat([d]));
            update(node);
        }
    });

    chart.click_bg(function() {
        var node = this.parentNode.parentNode.parentNode;
        var level = node.level;
        if (level.length > 1) {
            level.shift();
            update(node);
        }
    });

    chart.layout(function(data, node) {
        labels = ['Crate', 'Card', 'Channel'];
        var level = node.level;
        chart.xlabel(labels[level.length-1]);
        return d3.entries(sum_root(nav(data,level[0]))).sort(function(a,b) { return +a.key - +b.key; });
    });

    function sum_root(root) {
        function sum_node(node) {
            var sum = 0;
            if ($.type(node) == 'number')
                return node
            for (var key in node)
                sum += sum_node(node[key]);
            return sum;
        }
        function max_node(node) {
            var max = 0;
            if ($.type(node) == 'number')
                return node;
            for (var key in node) {
                var a = max_node(node[key]);
                max = (a > max) ? a : max;
            }
            return max;
        }
        var values = Object();
        for (var key in root)
            values[key] = max_node(root[key]);
        return values;
    }
</script>
<script>$('#nav-channels').attr('class','active');</script>
{% endblock %}
