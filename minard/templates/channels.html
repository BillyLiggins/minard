{% extends "layout.html" %}
{% block title %}Channels{% endblock %}
{% block head %}
{{ super() }}
<style>
    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

    .bar {
        fill: steelblue;
    }

    .x.axis path {
        display: none;
    }

    .x.label {
        font-size: 15px;
        font-weight: normal;
    }

    #hero .tick text {
        font-size: 10px;
    }
</style>
<meta charset="UTF-8">
<script src="{{ url_for('static', filename='js/d3.js') }}"></script>
<script src="{{ url_for('static', filename='js/bar-chart.js') }}"></script>
<script src="{{ url_for('static', filename='js/crate.js') }}"></script>
{% endblock %}
{% block body %}
{{ super() }}
<div class="row">
    <div class="col-md-5 col-md-offset-1" id="hero" style="position:relative">
        <h2>CMOS Rates</h2>
    </div>
</div>
<div class="row">
    <div class="container" id="crate">
        <h2>Crate View</h2>
    </div>
</div>
<script>
    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

    var crate = crate_view().threshold(10e3);

    setInterval(function() {
        $.getJSON($SCRIPT_ROOT + '/query', {name: 'cmos'}).done(function(result) {
            d3.selectAll('#crate').data([result.value]).call(crate);
        });
    }, 2000);

    var a = Object();

    setInterval(function() {
        $.getJSON($SCRIPT_ROOT + '/query', { name: 'cmos', format: 'nested' }).done(function(result) {
            a = result.value;
            update(sum_root(nav(result.value,level[0])));
        });
    }, 2000);

    function update(data) {
        d3.select('#hero').datum(data).call(chart);
    }

    var level = [[]];
    function nav(root, level) {
        for (var i=0; i < level.length; i++)
            root = root[level[i]]
        return root;
    }

    var chart = bar_chart().xlabel('Crate').margin({left:50});

    labels = ['Crate', 'Card', 'Channel'];

    chart.click(function(d, i) {
        if ($.type(nav(a,level[0])[d]) != 'number') {
            level.unshift(level[0].concat([d]));
            chart.xlabel(labels[level.length-1]);
            update(sum_root(nav(a,level[0])));
        }
    });

    chart.click_bg(function() {
        if (level.length > 1) {
            level.shift();
            chart.xlabel(labels[level.length-1]);
            update(sum_root(nav(a,level[0])));
        }
    });

    function sum_root(root) {
        function sum_node(node) {
            var sum = 0;
            if ($.type(node) == 'number')
                return node
            for (var key in node)
                sum += sum_node(node[key]);
            return sum;
        }
        var values = Object();
        for (var key in root)
            values[key] = sum_node(root[key]);
        return values;
    }
</script>
<script>$('#nav-channels').attr('class','active');</script>
{% endblock %}
