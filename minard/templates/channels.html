{% extends "layout.html" %}
{% block title %}Channels{% endblock %}
{% block head %}
{{ super() }}
<style>
    .axis path,
    .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

    .bar {
        fill: steelblue;
    }

    .x.axis path {
        display: none;
    }

    .x.label {
        font-size: 15px;
        font-weight: normal;
    }
</style>
<meta charset="UTF-8">
<script src="{{ url_for('static', filename='js/d3.js') }}"></script>
<script src="{{ url_for('static', filename='js/bar-chart.js') }}"></script>
<script src="{{ url_for('static', filename='js/crate.js') }}"></script>
{% endblock %}
{% block body %}
{{ super() }}
<div class="row">
    <div class="col-md-4" id="hero" style="position:relative">
        <h2>CMOS Rates</h2>
    </div>
</div>
<div class="row">
    <div class="container" id="crate">
        <h2>Crate View</h2>
    </div>
</div>
<script>
    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

    var crate = crate_view().threshold(10e3);

    setInterval(function() {
        $.getJSON($SCRIPT_ROOT + '/query', {name: 'cmos'}).done(function(result) {
            d3.selectAll('#crate').data([result.value]).call(crate);
        });
    }, 2000);

    function get_json() {
        return $.getJSON($SCRIPT_ROOT + '/query', { name: 'cmos', format: 'nested' });
    }

    var rand = d3.random.normal(5.0,5.0);
    var rand_int = function(start, stop) {
        return start + Math.floor(Math.random()*(stop-start)+1);
    }
    var a;
    function update_data() {
        a = Object();
        var N = 10;//rand_int(5,10);
        for (var i=0; i < N; i++) {
            a[i] = Object();
            for (var j=0; j < rand_int(15,20); j++) {
                a[i][j] = Object();
                for (var k=0; k < rand_int(20,25); k++) {
                    a[i][j][k] = rand();
                }
            }
        }
    }

    update_data();

    var level = [[]];
    function nav(root, level) {
        for (var i=0; i < level.length; i++)
            root = root[level[i]]
        return root;
    }

    setInterval(function() {
        get_json().done(update_json);
    },2000);

    var chart = bar_chart().xlabel('Crate');

    labels = ['Crate', 'Card', 'Channel'];

    chart.click(function(d, i) {
        if ($.type(nav(a,level[0])[d]) != 'number') {
            level.unshift(level[0].concat([d]));
            chart.xlabel(labels[level.length-1]);
            update(sum_root(nav(a,level[0])));
        }
    });

    chart.click_bg(function() {
        if (level.length > 1) {
            level.shift();
            chart.xlabel(labels[level.length-1]);
            update(sum_root(nav(a,level[0])));
        }
    });

    function sum_root(root) {
        function sum_node(node) {
            var sum = 0;
            if ($.type(node) == 'number')
                return node
            for (var key in node)
                sum += sum_node(node[key]);
            return sum;
        }
        var values = Object();
        for (var key in root)
            values[key] = sum_node(root[key]);
        return values;
    }

    update(sum_root(nav(a,level[0])));

    function update_json(result) {
        a = result.value;

        update(sum_root(nav(a,level[0])));
    }

    function update(node) {
        d3.select('#hero').datum(node).call(chart);
    }

</script>
<script>$('#nav-channels').attr('class','active');</script>
{% endblock %}
