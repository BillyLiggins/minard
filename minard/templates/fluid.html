{% extends "layout.html" %}
{% import 'histogram-chart.html' as histogram with context %}

{% block title %}Home{% endblock %}
{% block head %}
    {{ super() }}
    <style>

    .bar {
        fill: steelblue;
    }

    .axis text {
        font: 10px sans-serif;
    }

    .axis path, .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

    .x.label {
        font: 14px sans-serif;
    }

    .x.axis line {
        shape-rendering: auto;
    }

    .line {
      fill: none;
      stroke: #000;
      stroke-width: 1.5px;
    }

    .axis path, .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }

    .area {
        fill: #31a354;
        stroke: #000;
        stroke-width: 0;
        opacity: 0.25;
    }

    .title {
        line-height: 30px;
    }

    </style>

    <script src="{{ url_for('static', filename='js/d3.js') }}"></script>
    <script src="{{ url_for('static', filename='js/bar-chart.js') }}"></script>
    <script src="{{ url_for('static', filename='js/time-series.js') }}"></script>
{% endblock %}
{% block body %}
    {{ super() }}
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="row">
                    <div class="col-md-7" id="nhit">
                        <h2>NHit</h2>
                    </div><!--/span-->
                    <div class="col-md-3" id="info">
                        <h2>Info</h2>
                        <button type='button' class='btn btn-default' id='btn-start'>Start</button>
                        <button type='button' class='btn btn-default' id='btn-stop'>Stop</button>
                        <p>
                        <table class="table table-bordered">
                            <tr>
                                <td>Run #</td>
                                <td id='run'></td>
                            </tr>
                            <tr>
                                <td>First GTID</td>
                                <td id='gtid_first'></td>
                            </tr>
                            <tr>
                                <td>Last GTID</td>
                                <td id='gtid_last'></td>
                            </tr>
                            <tr>
                                <td>History</td>
                                <td>
                                    <button type='button' class='btn btn-default btn-xs'>-1</button>
                                    <button type='button' class='btn btn-default btn-xs'>+1</button>
                                    <button type='button' class='btn btn-default btn-xs'>+10</button>
                                    <button type='button' class='btn btn-default btn-xs'>+10</button>
                                </td>
                            </tr>
                            <tr>
                                <td>Time</td>
                                <td id='entry_time'></td>
                            </tr>
                        </table>
                    </div><!--/span-->
                </div>
                <div class="row">
                    <div class="col-md-10" id="pos">
                        <h2>Radial Position</h2>
                    </div><!--/span-->
                </div><!--/row-->
                <div class="row">
                    <div class="col-md-5" id="test1">
                        <h2>Test</h2>
                    </div><!--/span-->
                    <div class="col-md-5" id="test2">
                        <h2>Test</h2>
                    </div><!--/span-->
                </div><!--/row-->
            </div><!--/.fluid-container-->
        </div>
    </div>

    <script>$('#nav-home').attr('class','active');</script>

    <script>

    function alert(jqxhr, text_status, error) {
        var err = text_status + ', ' + error;

        var select = $('#info .alert');
        if (select.length == 0) {
            $('#info').prepend('<div class="alert alert-warning"></div>');
        }
        select = $('#info .alert');
        select.text(err);
    }

    function update_l2() {
        $.getJSON($SCRIPT_ROOT + '/query', {'name': 'l2_info'}, function(reply) {
            info = reply.value;
            $('#run').text(info.run);
            $('#gtid_first').text(info.gtid_first);
            $('#gtid_last').text(info.gtid_last);
            $('#entry_time').text(info.entry_time);
        }).fail(alert);
    }

    var intervalid = setInterval(update_l2,1000);

    $('#btn-stop').click(function() {
        clearInterval(intervalid);
        intervalid = null;
    });

    $('#btn-start').click(function() {
        if (intervalid == null)
            intervalid = setInterval(update_l2,1000);
    });

    function update_chart(selector, url, name, chart, time) {
        time = (typeof time === 'undefined') ? 10 : time;

        function update(value) {
            d3.selectAll(selector).data([value]).call(chart);
        }

        function request() {
            $.getJSON(url, {'name': name}, function(reply) { update(reply.value); });
        }

        request();
        setInterval(request,time*1000);
    }

    var chart1 = bar_chart().height(100);
    var chart2 = bar_chart().height(100).xlabel('Position (cm)');
    var hist = d3.layout.histogram().bins(d3.range(10));
    var chart3 = bar_chart().layout(hist);

    update_chart('#nhit', $SCRIPT_ROOT + '/query', 'nhit', chart1);
    update_chart('#pos', $SCRIPT_ROOT + '/query', 'pos', chart2);
    update_chart('#test1',$SCRIPT_ROOT + '/query', '', chart3, 1);
    update_chart('#test2', $SCRIPT_ROOT + '/query', '', chart3, 1);
    </script>
{% endblock %}
</html>
