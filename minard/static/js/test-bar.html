<html>
    <head>
        <style>
            body {
                font: 10px sans-serif;
            }

            .axis path,
            .axis line {
                fill: none;
                stroke: #000;
                shape-rendering: crispEdges;
            }

            .bar {
                fill: steelblue;
            }

            .x.axis path {
                display: none;
            }
        </style>
        <meta charset="UTF-8">
        <script src="d3.js"></script>
        <script src="jquery.js"></script>
        <script src="bar-chart.js"></script>
    </head>
    <body>
        <div id="test1"></div>
        <div id="test2"></div>
        <script>
            var rand = d3.random.normal(5.0,5.0);
            var rand_int = function(start, stop) {
                return start + Math.floor(Math.random()*(stop-start)+1);
            }
            var a;
            function update_data() {
                a = Object();
                var N = 10;//rand_int(5,10);
                for (var i=0; i < N; i++) {
                    a[i] = Object();
                    for (var j=0; j < rand_int(15,20); j++) {
                        a[i][j] = Object();
                        for (var k=0; k < rand_int(20,25); k++) {
                            a[i][j][k] = rand();
                        }
                    }
                }
            }

            update_data();

            var level = [[]];
            function nav(root, level) {
                for (var i in level)
                    root = root[i]
                return root;
            }

            setInterval(function() {
                update_data();
                update(sum_root(nav(a,level[0])));
            },10000);

            var chart = bar_chart().xlabel('Crate');

            labels = ['Crate', 'Card', 'Channel'];

            chart.click(function(d, i) {
                if ($.type(nav(a,level[0])[d]) != 'number') {
                    level.unshift(level[0].concat([d]));
                    chart.xlabel(labels[level.length-1]);
                    update(sum_root(nav(a,level[0])));
                }
            });

            chart.click_bg(function() {
                if (level.length > 1) {
                    level.shift();
                    chart.xlabel(labels[level.length-1]);
                    update(sum_root(nav(a,level[0])));
                }
            });

            function sum_root(root) {
                function sum_node(node) {
                    var sum = 0;
                    if ($.type(node) == 'number')
                        return node
                    for (var key in node)
                        sum += sum_node(node[key]);
                    return sum;
                }
                var values = Object();
                for (var key in root)
                    values[key] = sum_node(root[key]);
                return values;
            }

            update(sum_root(nav(a,level[0])));

            function update(node) {
                d3.select('#test1').datum(node).call(chart);
            }

            var chart2 = histogram_chart();
            d3.select('#test2').datum([1.5,2,3,4,5]).call(chart2);
        </script>
    </body>
</html>
